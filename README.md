IDA Pro Disassembling of Lab01-02.exe

1.  Start Ida pro and select lab01-02.exe

    1.  <img src="./media/image1.PNG" style="width:4.57292in;height:4.96667in"
        alt="A diagram of a diagram Description automatically generated" /><img src="./media/image2.PNG" style="width:6.5in;height:2.89861in"
        alt="A screenshot of a computer Description automatically generated" />Look
        at graph view to see structure of functions and how their
        connected:

    2.  Looking at the function circled you can see where the Packing
        executable ends and where the real malware package begins:

        1.  Add a break point onto the jmp near ptr dword_401190 for
            manual unpacking in the debugger.

> <img src="./media/image3.PNG" style="width:6.26129in;height:3.66718in"
> alt="A screenshot of a computer program Description automatically generated" />

3.  After looking at the graph it is beneficial to also check the
    imports section to see what the malware is attempting to do.

> <img src="./media/image4.PNG" style="width:6.5in;height:1.48681in"
> alt="A screenshot of a computer Description automatically generated" />

1.  Looking at the imports you can see that lab01-02.exe is
    packed(above)

2.  In this import section you can see LoadLibraryA, GetProcAddress,
    createServiceA, and InternetOpenA which is more evidence that the
    malware is packed

    1.  These imply that the malware is going to open the internet and
        create a service

<!-- -->

2.  Using text view:

    1.  You can see that the lab01-02.exe was packed with UPX:

> <img src="./media/image5.PNG" style="width:3.00106in;height:3.76767in"
> alt="A screen shot of a computer code Description automatically generated" />

3.  View after unpacking this malware with UPX (There are ways to
    manually unpack this malware but since we know it is using UPX we
    can unpack it using that packer. To unpack manually use tools like
    PEditor and Scylla to dump the real executable from ram into a file
    here is a good video on how to do so:
    <https://www.youtube.com/watch?v=vvk_ISkKOAE>):

    1.  View of functions after unpacked:

<img src="./media/image6.PNG" style="width:6.5in;height:1.62292in"
alt="A screenshot of a computer Description automatically generated" />

4.  Looking at new uncovered functions(below):

<img src="./media/image7.PNG" style="width:2.875in;height:1.78125in"
alt="A computer screen with text on it Description automatically generated" /><img src="./media/image8.PNG" style="width:2.25in;height:1.80208in"
alt="A screenshot of a computer Description automatically generated" /><img src="./media/image9.PNG" style="width:2.85417in;height:2.54167in"
alt="A screenshot of a computer program Description automatically generated" /><img src="./media/image10.PNG" style="width:2.57292in;height:1.85417in"
alt="A screenshot of a computer Description automatically generated" /><img src="./media/image11.PNG" style="width:1.73958in;height:1.6875in"
alt="A screenshot of a computer Description automatically generated" /><img src="./media/image12.PNG" style="width:3.72917in;height:2.47917in"
alt="A screen shot of a computer program Description automatically generated" /><img src="./media/image13.PNG" style="width:4.12292in;height:1.79097in"
alt="A screenshot of a computer Description automatically generated" /><img src="./media/image14.PNG" style="width:3.29167in;height:8.41736in"
alt="A screen shot of a computer Description automatically generated" />

5.  <img src="./media/image15.PNG" style="width:3.48958in;height:4.14722in"
    alt="A screenshot of a computer program Description automatically generated" /><img src="./media/image16.PNG" style="width:4.91181in;height:7.3125in"
    alt="A screenshot of a computer program Description automatically generated" /><img src="./media/image17.PNG" style="width:3.66111in;height:5.48056in"
    alt="A screenshot of a computer program Description automatically generated" />Within
    these functions it is important to look at the CALL and JMP commands
    as these are used to go to or call another function or process which
    is used by the malware.

    1.  Looking at the main function you can see that it uses the CALL
        command to call sub_401040 which is the where the startAddress
        function is. Within the start address function you can see it
        calling the imported functions InternetOpenA and
        InternetOpenUrlA. The Actual URL that is being opened is within
        the szUrl variable(this variable is see within the startAddress
        function too):
        [www.malwareanalysisbook.com](http://www.malwareanalysisbook.com)

    2.  For even more specifics you are able to use IDA Pro to decompile
        the assembly into a higher level language. This functionality
        can be very helpful for determining what a malicious sample is
        doing, keep in mind that this extrapolation upwards is only a
        guess as IDA pro is using estimation to generate these
        Screenshots that are bellow:

        1.  To get the sudo code to show is by pressing f5 in the
            function.

<img src="./media/image18.PNG" style="width:4.90625in;height:3.70136in"
alt="A computer screen shot of a program Description automatically generated" /><img src="./media/image19.PNG" style="width:5.07292in;height:2.14111in"
alt="A computer screen shot of a program Description automatically generated" />

<img src="./media/image20.PNG" style="width:5.76042in;height:0.88068in"
alt="A screen shot of a computer Description automatically generated" />

<img src="./media/image21.PNG" style="width:6.5in;height:4.47986in"
alt="A computer screen shot of a program Description automatically generated" />

6.  <img src="./media/image22.PNG" style="width:8.5737in;height:4.76042in"
    alt="A screenshot of a computer program Description automatically generated" />how
    debugger works in detail09

    1.  The IDA pro debugger allows for breakpoints to be set and for
        the user to step through the code to see what the malware would
        do if it was run on an unsuspecting machine.

    2.  The debugger has a few key windows that allow for better and
        easier analysis, the module section shows all DLL imports that
        have been accessed by the .exe

    3.  the threads section shows all threads generated by the malware
        and allowing you to double click into them allowing for further
        investigation

    4.  The register view shows all values and variables currently in
        them helping with tracing specific commands or variables

    5.  The stack view displays local and temporary variables, incoming
        arguments that are used in calling, saved volatile registers,
        and addresses

Ghidra Disassembling of Lab01-02.exe

1.  Open Ghidra and create a new project, then import the selected file

<img src="./media/image23.png"
style="width:4.11767in;height:3.1042in" /><img src="./media/image24.png"
style="width:3.89474in;height:2.95117in" />

Import Results

<img src="./media/image25.png"
style="width:3.21448in;height:3.45833in" />

2.  Double click the malware file to analyze, the code browser will
    open, click yes

<img src="./media/image26.png"
style="width:1.67015in;height:0.77084in" /><img src="./media/image27.png"
style="width:4.39157in;height:4.2297in" />

3.  Analysis Options will open, select “WindowsPE x86 Propagate External
    Paramaters” to help analyze function parameters, click apply then
    analyze

Program Trees and Symbol Trees help parse out the file's headers,
imports, exports, functions, etc.

<img src="./media/image28.png" style="width:2.194in;height:1.83334in" /><img src="./media/image29.png"
style="width:2.09392in;height:1.89584in" />

4.  By going to “entry” in the Symbol Tree, you can see the entry point
    of the
    malware<img src="./media/image30.png" style="width:6.5in;height:1.92708in" />

5.  Click “Display Decompiler” to show Ghidra’s attempt at decompiling
    the selected code into C

<img src="./media/image31.png"
style="width:4.85417in;height:3.64063in" />

You can see the entry function is an initializer by its conduction of
base tasks such as getCommandLine and getVersion, while calling many
other functions

6.  Click “Display function graph” to show a visual representation of
    the flow of the malware <img src="./media/image32.png"
    style="width:4.70833in;height:4.49706in" />

7.  You can search by clicking “Search” in the toolbar and clicking
    “Search Program Text”. This will search through the program and find
    matches for what you type. In this instance I searched for any
    references to “command” to see how the malware is accessingthe
    command lline. <img src="./media/image33.png"
    style="width:4.41667in;height:2.94444in" />

8.  Change function names to log functionality. Right click, Edit
    Function, save changes <img src="./media/image34.png"
    style="width:4.70837in;height:3.81253in" /><img src="./media/image35.png"
    style="width:5.42712in;height:3.52086in" />

x64dbg Disassembling of Lab01-02.exe

1.  x64dbg has a 32-bit version and a 64-bit version depending on what
    type of bit the malware is. In this case Lab01-02.exe is 32-bit so
    open it with the 32-bit version.

2.  When you hover above this icon you can see the prompt to run user
    code. This will take you to the address of the entry
    point.<img src="./media/image36.jpg" style="width:5in;height:3.5625in"
    alt="A screenshot of a computer Description automatically generated" />

3.  After this you can step through the program to see how it works
    while creating breakpoints for significant portions.

<img src="./media/image37.jpg" style="width:5.63542in;height:4.00079in"
alt="A screenshot of a computer Description automatically generated" />

4.  This file is packed but you can execute the program within x64dbg to
    unpack it.

5.  If you right click on the cpu tab contents you can search for the
    intermodular calls and investigate all the calls made.

<img src="./media/image38.jpg" style="width:6.5in;height:4.61458in"
alt="A screenshot of a computer Description automatically generated" />

6.  <img src="./media/image39.png" style="width:6.5in;height:4.69792in" />

Here in memory map you can see the exe has UPX, so it is packed.
